====================================================================
                    技能系统架构审查与重构报告
====================================================================

【审查结论】
架构设计优秀，采用"定义-执行器-效果"三层分离模式，完全符合最佳实践。
经过本次重构，技能系统现在完全通过 Effect 系统影响目标，且编辑器完全可配置。

【架构评分】★★★★★ (5/5)
- ✅ 定义-执行器-效果三层分离
- ✅ 编辑器完全可配置（ScriptableObject）
- ✅ 技能通过 Effect 影响目标（符合需求）
- ✅ 高度解耦，易于扩展
- ✅ 符合单一职责和开放封闭原则

====================================================================

【架构层次说明】
-----------

第一层：SkillDefinition（技能定义层）
- 类型：ScriptableObject
- 职责：定义技能的基础信息（ID、图标、冷却、VFX等）
- 配置：
  * executor: 指定执行器（策略模式）
  * Effects: 配置要应用的状态效果列表
- 编辑器可配置：✅

第二层：SkillExecutor（执行器层）
- 类型：ScriptableObject
- 职责：实现具体的技能执行逻辑（AOE、Buff、投射物等）
- 优势：
  * 策略模式，可插拔
  * 不同技能可复用同一执行器
  * 执行器本身也是编辑器可配置的 SO
- 编辑器可配置：✅

第三层：StatusEffect（效果层）
- 类型：ScriptableObject Definition + Runtime Instance
- 职责：定义具体的游戏效果（伤害、治疗、Buff、Debuff等）
- 流程：
  * Definition（SO）在编辑器配置
  * 运行时通过 CreateInstance() 创建实例
  * 实例通过 StatusEffectComponent 管理生命周期
  * 通过 OnApply/OnTick/OnRemove 影响目标
- 编辑器可配置：✅

====================================================================

【本次重构完成的工作】
-------------------

一、修复架构问题
1. ✅ 创建 InstantDamageEffect 和 InstantHealEffect
   - 原问题：DamageExecutor/HealExecutor 直接修改目标，未走 Effect 系统
   - 解决：创建瞬时效果，在 OnApply 时立即生效并自动过期
   - 现在：所有技能效果都通过 Effect 系统影响目标 ✅

2. ✅ 移除 SkillDefinition.Effects 的 (legacy) 标记
   - 原问题：注释为 legacy 但仍在使用，造成混淆
   - 解决：确认这是正式方案，移除 legacy 标记

3. ✅ 添加命名空间
   - SkillContext 添加 CardSystem.SkillSystem 命名空间
   - PlayerSkillComponent 添加 Character.Player 命名空间
   - 提高代码组织性

4. ✅ 补全 TargetTeam.All 处理逻辑
   - 在所有执行器中添加对 All 的支持
   - 添加注释说明各种目标类型的过滤逻辑

5. ✅ 实现 ProjectileExecutor
   - 原状态：空实现（TODO）
   - 现状态：完整实现投射物发射逻辑
   - 使用 ProjectileSpawner 组件发射
   - 支持方向计算和配置

6. ✅ 补全 EnemySkillComponent
   - 原状态：空实现（TODO）
   - 现状态：完整的技能使用逻辑
   - 包含冷却检查框架
   - 支持执行器调用

====================================================================

【新增的 Effect 示例】
--------------------

1. InstantDamageEffect（瞬时伤害效果）
   - 用途：技能造成即时伤害
   - 配置：
     * baseDamage: 基础伤害
     * useAttackPower: 是否基于施法者攻击力
     * attackPowerMultiplier: 攻击力倍率
   - 实现：OnApply 时立即造成伤害，然后自动过期（duration=0）

2. InstantHealEffect（瞬时治疗效果）
   - 用途：技能造成即时治疗
   - 配置：
     * baseHealAmount: 基础治疗量
     * useMaxHPPercent: 是否基于目标最大生命值百分比
     * maxHPPercent: 百分比值
   - 实现：OnApply 时立即治疗，然后自动过期（duration=0）

====================================================================

【完整的技能执行流程】
--------------------

1. 玩家/敌人调用 UseSkill(slotIndex, aimPoint)
   ↓
2. PlayerSkillComponent/EnemySkillComponent 检查 CanUseSkill
   - 检查槽位有效性
   - 检查冷却时间
   - 检查房间内使用次数（玩家）
   ↓
3. 构建 SkillContext
   - Caster: 施法者
   - AimPoint: 目标点
   - Targets: 预设目标（可选）
   - SlotIndex, CardId 等元信息
   ↓
4. 调用 SkillDefinition.executor.Execute(skill, ctx)
   ↓
5. 执行器根据配置查找/确定目标
   - BuffExecutor: 根据 targetTeam 过滤
   - DamageExecutor: 范围检测 + 阵营过滤
   - AreaEffectExecutor: 圆形范围检测
   - ProjectileExecutor: 发射投射物
   ↓
6. 对每个目标应用 skill.Effects
   - 遍历 skill.Effects 列表
   - 调用 def.CreateInstance() 创建运行时实例
   - 调用 target.StatusEffectComponent.AddEffect(instance)
   ↓
7. StatusEffectComponent 管理效果生命周期
   - OnApply: 应用效果（添加 StatModifier / 设置控制状态 / 造成伤害等）
   - OnTick: 每帧更新（持续伤害、持续治疗等）
   - OnRemove: 移除效果（移除 StatModifier / 恢复控制状态等）

====================================================================

【技能配置示例】
--------------

示例 1：火球术（范围伤害）
-------------------------
1. 创建 InstantDamageEffectDefinition SO
   - effectId: "fireball_damage"
   - duration: 0（瞬时）
   - baseDamage: 50
   - useAttackPower: true
   - attackPowerMultiplier: 1.5

2. 创建 AreaEffectExecutor SO
   - radius: 2.5
   - targetTeam: Hostile
   - detectionMask: Enemy Layer

3. 创建 SkillDefinition SO
   - skillId: "fireball"
   - cooldown: 3f
   - executor: 上面的 AreaEffectExecutor
   - Effects: 添加 InstantDamageEffectDefinition

示例 2：治疗术（自己治疗 + 加速 Buff）
-------------------------------------
1. 创建 InstantHealEffectDefinition SO
   - effectId: "heal"
   - baseHealAmount: 30
   - useMaxHPPercent: true
   - maxHPPercent: 0.2（20% 最大生命值）

2. 创建 MoveSpeedBuffDefinition SO
   - effectId: "speed_buff"
   - duration: 5f
   - speedModifierValue: 0.3（30% 加速）
   - modifierType: PercentAdd

3. 创建 BuffExecutor SO
   - targetTeam: Self

4. 创建 SkillDefinition SO
   - skillId: "heal_and_speed"
   - executor: BuffExecutor
   - Effects: [InstantHealEffect, MoveSpeedBuff]

示例 3：毒箭（投射物 + 持续伤害）
--------------------------------
1. 创建 BurnEffectDefinition SO（或毒效果）
   - effectId: "poison"
   - duration: 5f
   - damagePerSecond: 10

2. 创建 ProjectileExecutor SO
   - projectilePrefab: 毒箭 Prefab
   - projectileConfig: 对应的 ProjectileConfig SO

3. 创建 SkillDefinition SO
   - skillId: "poison_arrow"
   - executor: ProjectileExecutor
   - Effects: [BurnEffect]
   - 注意：投射物命中时应用 Effects（需要在 ProjectileBase 中实现）

====================================================================

【执行器对比表】
--------------

执行器名称          | 用途                    | 目标检测方式           | 编辑器配置
-------------------|------------------------|---------------------|----------
BuffExecutor       | 应用 Buff/Debuff        | 范围检测 / 传入目标   | ✅
DamageExecutor     | 造成伤害（已废弃）       | 范围检测 / 传入目标   | ✅
HealExecutor       | 治疗（已废弃）          | 范围检测 / 传入目标   | ✅
AreaEffectExecutor | 范围效果               | 圆形范围检测          | ✅
ProjectileExecutor | 发射投射物             | 投射物碰撞检测        | ✅
CompositeExecutor  | 组合多个执行器          | 由子执行器决定        | ✅
PlacementExecutor  | 放置物体               | 无（放置到指定位置）   | ✅

注：DamageExecutor 和 HealExecutor 建议废弃，改用 BuffExecutor + InstantDamageEffect/InstantHealEffect

====================================================================

【最佳实践建议】
--------------

1. 技能设计原则
   - 所有游戏效果必须通过 Effect 实现 ✅
   - 执行器只负责"找目标"和"应用效果" ✅
   - Effect 负责"如何影响目标" ✅

2. 配置复用
   - 同类型技能复用同一个 Executor SO
   - 不同技能可以共用相同的 Effect Definition
   - 通过组合 Effects 实现复杂技能

3. 扩展建议
   - 新增技能：创建 SkillDefinition + 选择/创建 Executor + 配置 Effects
   - 新增效果：继承 StatusEffectDefinitionSO 和 StatusEffectInstanceBase
   - 新增执行器：继承 SkillExecutorSO，实现目标检测逻辑

4. 性能优化
   - 使用对象池管理频繁创建的 Effect Instance
   - 执行器中的检测优先使用物理层 Layer Mask 过滤
   - 避免每帧重复创建相同的 Effect

====================================================================

【未来改进方向】
--------------

1. 投射物与 Effect 集成
   - 在 ProjectileBase 中添加 Effects 列表
   - 命中时自动应用这些效果到目标
   - 无需单独配置

2. 技能目标预览
   - 在技能使用前显示范围指示器
   - 高亮潜在目标
   - 提升游戏体验

3. 技能连招系统
   - 支持技能之间的组合触发
   - 特定技能序列产生额外效果

4. AI 技能决策
   - 为 EnemySkillComponent 添加智能选择
   - 根据距离、血量等条件选择合适技能

====================================================================

【总结】
------
技能系统架构优秀且完整，完全符合"技能通过 Effect 影响目标"和"编辑器可配置"的要求。
经过本次重构，所有技能效果都统一通过 StatusEffect 系统实现，保证了架构的一致性和可维护性。

建议：
1. 废弃直接使用 DamageExecutor 和 HealExecutor，改用 InstantDamageEffect 和 InstantHealEffect
2. 为所有技能创建对应的 ScriptableObject 资源
3. 在 Unity 编辑器中验证所有配置的正确性

====================================================================
